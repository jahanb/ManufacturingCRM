<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

<h:head>
    <title>Product Management</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .page-header h1 {
            margin: 0;
            font-size: 24px;
            display: inline-block;
        }

        .nav-menu {
            float: right;
            margin-top: 5px;
        }

        .nav-menu a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            margin-left: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }

        .nav-menu a:hover {
            background: rgba(255,255,255,0.3);
        }

        .content-wrapper {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .photo-viewer-dialog .ui-dialog-content {
            background: #f8f9fa;
        }
    </style>
</h:head>

<h:body>

    <!-- Header -->
    <div class="page-header">
        <h1>Product Management</h1>
        <div class="nav-menu">
            <h:link outcome="/index" value="Home" />
            <h:link outcome="/products" value="Products" />
            <h:link outcome="/sales" value="Sales" />
            <h:link outcome="/graph" value="Analytics" />
        </div>
        <div style="clear: both;"></div>
    </div>

    <div class="content-wrapper">

        <!-- Main Product Form -->
        <h:form id="productForm">
            <p:growl id="messages" showDetail="true" life="3000" />

            <div class="card">
                <p:toolbar>
                    <p:toolbarGroup>
                        <p:commandButton value="New Product" icon="pi pi-plus"
                                         actionListener="#{productBean.openNew}"
                                         update=":dialogForm"
                                         oncomplete="PF('dlg').show()"
                                         styleClass="ui-button-success" />
                        <p:commandButton value="Refresh" icon="pi pi-refresh"
                                         actionListener="#{productBean.loadProducts}"
                                         update="productTable messages"
                                         styleClass="ui-button-info" />
                    </p:toolbarGroup>
                    <p:toolbarGroup align="right">
                        <h:outputText value="Total: #{productBean.products.size()} products" style="font-weight: bold;" />
                    </p:toolbarGroup>
                </p:toolbar>
            </div>

            <!-- Products Table -->
            <div class="card">
                <p:dataTable id="productTable" var="prod" value="#{productBean.products}"
                             paginator="true" rows="10" rowKey="#{prod.id}"
                             paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                             rowsPerPageTemplate="5,10,15,20"
                             emptyMessage="No products found">

                    <p:column headerText="Photo" style="width: 100px; text-align: center;">
                        <h:panelGroup rendered="#{not empty prod.photo}">
                            <img src="#{productBean.getProductImageAsBase64(prod)}"
                                 alt="#{prod.name}"
                                 style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; cursor: pointer;"
                                 onclick="PF('photoViewer').show(); document.getElementById('viewerImage').src='#{productBean.getProductImageAsBase64(prod)}'; document.getElementById('viewerTitle').innerHTML='#{prod.name}';" />
                        </h:panelGroup>
                        <h:panelGroup rendered="#{empty prod.photo}">
                            <i class="pi pi-image" style="font-size: 2rem; color: #ccc;"></i>
                        </h:panelGroup>
                    </p:column>

                    <p:column headerText="Code" sortBy="#{prod.code}" filterBy="#{prod.code}" filterMatchMode="contains">
                        <h:outputText value="#{prod.code}" />
                    </p:column>

                    <p:column headerText="Name" sortBy="#{prod.name}" filterBy="#{prod.name}" filterMatchMode="contains">
                        <h:outputText value="#{prod.name}" />
                    </p:column>

                    <p:column headerText="Category" sortBy="#{prod.category}">
                        <h:outputText value="#{prod.category}" />
                    </p:column>

                    <p:column headerText="Price" sortBy="#{prod.price}" style="text-align: right;">
                        <h:outputText value="#{prod.price}">
                            <f:convertNumber type="currency" currencySymbol="$" />
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Quantity" sortBy="#{prod.quantity}" style="text-align: center;">
                        <h:outputText value="#{prod.quantity}" />
                    </p:column>

                    <p:column headerText="Status">
                        <p:tag value="#{prod.status}"
                               severity="#{prod.status == 'INSTOCK' ? 'success' : (prod.status == 'LOWSTOCK' ? 'warning' : 'danger')}" />
                    </p:column>

                    <p:column headerText="Actions" style="width: 120px; text-align: center;">
                        <p:commandButton icon="pi pi-pencil" title="Edit"
                                         actionListener="#{productBean.editProduct(prod)}"
                                         update=":dialogForm"
                                         oncomplete="PF('dlg').show()"
                                         process="@this"
                                         styleClass="ui-button-success ui-button-rounded ui-button-sm"
                                         style="margin-right: 5px;" />
                        <p:commandButton icon="pi pi-trash" title="Delete"
                                         actionListener="#{productBean.deleteProduct(prod)}"
                                         process="@this"
                                         update=":productForm:productTable :productForm:messages"
                                         styleClass="ui-button-danger ui-button-rounded ui-button-sm">
                            <p:confirm message="Delete #{prod.name}?" icon="pi pi-exclamation-triangle" />
                        </p:commandButton>
                    </p:column>
                </p:dataTable>
            </div>
        </h:form>

        <!-- âœ… Global Confirm Dialog (must be outside main forms) -->
        <h:form id="confirmForm">
            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" icon="pi pi-check" />
                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="pi pi-times" />
            </p:confirmDialog>
        </h:form>

        <!-- Photo Viewer Dialog -->
        <h:form id="photoViewerForm">
            <p:dialog id="photoViewerDialog" widgetVar="photoViewer" modal="true"
                      responsive="true" width="800" height="600" fitViewport="true"
                      styleClass="photo-viewer-dialog">

                <f:facet name="header">
                    <h:outputText id="viewerTitle" value="Product Photo" style="font-weight: bold;" />
                </f:facet>

                <div style="text-align: center; padding: 20px;">
                    <img id="viewerImage" src="" alt="Product Photo"
                         style="max-width: 100%; max-height: 500px; object-fit: contain;
                        border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" />
                </div>

                <f:facet name="footer">
                    <p:commandButton value="Close" icon="pi pi-times"
                                     onclick="PF('photoViewer').hide()"
                                     type="button"
                                     styleClass="ui-button-secondary" />
                </f:facet>
            </p:dialog>
        </h:form>

        <!-- Dialog Form -->
        <h:form id="dialogForm" enctype="multipart/form-data">
            <p:dialog id="productDialog" header="Product Details" widgetVar="dlg" modal="true"
                      width="700" height="600" responsive="true" fitViewport="true">

                <h:panelGroup rendered="#{productBean.product != null}">
                    <p:messages id="dialogMessages" showDetail="true" closable="true" />

                    <div style="max-height: 450px; overflow-y: auto; padding: 10px;">
                        <h:panelGrid columns="2" cellpadding="10" style="width: 100%;" columnClasses="label-col,input-col">

                            <p:outputLabel value="Code:" for="code"/>
                            <p:inputText id="code" value="#{productBean.product.code}" required="true" style="width: 100%;" />

                            <p:outputLabel value="Name:" for="name"/>
                            <p:inputText id="name" value="#{productBean.product.name}" required="true" style="width: 100%;" />

                            <p:outputLabel value="Category:" for="category"/>
                            <p:inputText id="category" value="#{productBean.product.category}" style="width: 100%;" />

                            <p:outputLabel value="Price:" for="price"/>
                            <p:inputNumber id="price" value="#{productBean.product.price}" symbol="$ " decimalPlaces="2" style="width: 100%;" />

                            <p:outputLabel value="Quantity:" for="quantity"/>
                            <p:inputNumber id="quantity" value="#{productBean.product.quantity}" decimalPlaces="0" style="width: 100%;" />

                            <p:outputLabel value="Status:" for="status"/>
                            <p:selectOneMenu id="status" value="#{productBean.product.status}" style="width: 100%;">
                                <f:selectItem itemLabel="Select Status" itemValue="" />
                                <f:selectItem itemLabel="In Stock" itemValue="INSTOCK" />
                                <f:selectItem itemLabel="Low Stock" itemValue="LOWSTOCK" />
                                <f:selectItem itemLabel="Out of Stock" itemValue="OUTOFSTOCK" />
                            </p:selectOneMenu>

                            <p:outputLabel value="Available:" for="available"/>
                            <p:selectBooleanCheckbox id="available" value="#{productBean.product.available}" />

                            <p:outputLabel value="Photo:" style="vertical-align: top;" />
                            <h:panelGroup>
                                <h:panelGroup rendered="#{productBean.hasPhoto()}" style="display: block; margin-bottom: 10px;">
                                    <img src="#{productBean.getProductImageAsBase64(productBean.product)}"
                                         alt="Product Photo"
                                         style="width: 200px; height: 200px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 10px;" />
                                    <p:commandButton value="Remove Photo" icon="pi pi-times"
                                                     styleClass="ui-button-danger ui-button-sm"
                                                     actionListener="#{productBean.removePhoto}"
                                                     update="@form"
                                                     process="@this" />
                                </h:panelGroup>

                                <p:fileUpload id="photoUpload"
                                              mode="simple"
                                              value="#{productBean.uploadedFile}"
                                              listener="#{productBean.handleFileUpload}"
                                              allowTypes="/(\.|\/)(jpe?g|png|gif|webp)$/i"
                                              sizeLimit="5000000"
                                              accept="image/*"
                                              invalidSizeMessage="Maximum file size is 5MB"
                                              invalidFileMessage="Only image files (JPG, PNG, GIF, WEBP) are allowed"
                                              style="width: 100%;" />
                            </h:panelGroup>
                        </h:panelGrid>
                    </div>
                </h:panelGroup>

                <f:facet name="footer">
                    <p:commandButton value="Save" icon="pi pi-check"
                                     actionListener="#{productBean.saveProduct}"
                                     update=":productForm:productTable :productForm:messages dialogForm"
                                     oncomplete="if(!args.validationFailed) PF('dlg').hide()"
                                     styleClass="ui-button-success" />
                    <p:commandButton value="Cancel" icon="pi pi-times"
                                     onclick="PF('dlg').hide()"
                                     type="button"
                                     styleClass="ui-button-secondary" />
                </f:facet>
            </p:dialog>
        </h:form>
    </div>

</h:body>
</html>
